parameters:
- name: ScanFolder
  type: string
  default: "$(Build.SourcesDirectory)"
- name: SuppressionsFile
  type: string
- name: ArtifactFolder
  type: string
  default: "$(Build.ArtifactStagingDirectory)"

steps:
  - task: securedevelopmentteam.vss-secure-development-tools.build-task-credscan.CredScan@3
    displayName: Invoke CredScan
    inputs:
      toolVersion: 2.3.12.23
      scanFolder: ${{ parameters.ScanFolder }}
      suppressionsFile: ${{ parameters.SuppressionsFile }}

  - task: securedevelopmentteam.vss-secure-development-tools.build-task-postanalysis.PostAnalysis@2
    displayName: Analyze Credscan Results
    inputs:
      GdnBreakAllTools: false
      GdnBreakGdnToolCredScan: true
      GdnBreakGdnToolCredScanSeverity: Error
      GdnBreakCustomLogsFolder: ${{ parameters.ArtifactFolder }}

  - task: PublishPipelineArtifact@1
    condition: failed()
    displayName: 'Publish Credscan Artifact'
    inputs:
      artifactName: $(Tag)
      path: ${{ parameters.ArtifactFolder }}

  - pwsh: |
      Get-ChildItem -Recurse $(Build.SourcesDirectory) | % { Write-Host $_.FullName }
    displayName: Parse Failing Credscan Results
    condition: failed()